#!/bin/sh

# PROVIDE: mastodon_web
# REQUIRE: LOGIN

# Add the following line to /etc/rc.conf to enable `mastodon_web':
#
#mastodon_enable="YES"

. /etc/rc.subr

name="mastodon_web"
rcvar="mastodon_enable"

load_rc_config "mastodon"
: ${mastodon_enable="NO"}
: ${mastodon_path="/usr/local/www/mastodon"}
: ${mastodon_user="mastodon"}
: ${mastodon_env="production"}
: ${mastodon_threads="20"}

export PATH=${PATH}:/usr/local/bin:/usr/local/sbin
export LANG=ja_JP.UTF-8
export LC_ALL=ja_JP.UTF-8
export RAILS_ENV=$mastodon_env
export DB_POOL=$mastodon_threads

start_cmd=${name}_start
stop_cmd=${name}_stop

mastodon_web_start() {
  cd $mastodon_path
  sudo -u $mastodon_user zsh -c 'bundle exec rails server -u puma | logger -t mastodon_web &'
}

mastodon_web_stop() {
  pkill -U $mastodon_user -f puma
}

run_rc_command "$1"
