server {
  listen 80;
<<<<<<<< HEAD:dist/servers/precure.ml.conf
  server_name precure.ml;
  access_log syslog:server=127.0.0.1,tag=nginx_curesta,severity=info combined;
========
  server_name mstdn.delmulin.com;
  access_log syslog:server=127.0.0.1,tag=nginx_delmulin,severity=info combined;
>>>>>>>> work/4.3/delmulin:dist/servers/mstdn.delmulin.com.conf

  location /.well-known/acme-challenge/ {
    root /usr/local/www/mastodon/public;
  }
  location / {
    return 301 https://$host$request_uri;
  }
}

server {
  listen 443 ssl;
  http2 on;
<<<<<<<< HEAD:dist/servers/precure.ml.conf
  server_name precure.ml;
  access_log syslog:server=127.0.0.1,tag=nginx_curesta,severity=info combined;
========
  server_name mstdn.delmulin.com;
  access_log syslog:server=127.0.0.1,tag=nginx_delmulin,severity=info combined;
>>>>>>>> work/4.3/delmulin:dist/servers/mstdn.delmulin.com.conf

  ssl_protocols TLSv1.3 TLSv1.2;
  ssl_prefer_server_ciphers on;
  ssl_session_cache shared:SSL:10m;
<<<<<<<< HEAD:dist/servers/precure.ml.conf
  ssl_certificate /usr/local/etc/letsencrypt/live/precure.ml/fullchain.pem;
  ssl_certificate_key /usr/local/etc/letsencrypt/live/precure.ml/privkey.pem;
========
  ssl_certificate /usr/local/etc/letsencrypt/live/delmulin.com/fullchain.pem;
  ssl_certificate_key /usr/local/etc/letsencrypt/live/delmulin.com/privkey.pem;
>>>>>>>> work/4.3/delmulin:dist/servers/mstdn.delmulin.com.conf
  add_header Strict-Transport-Security max-age=63072000;

  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto https;
  proxy_set_header Proxy "";
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection $connection_upgrade;
  proxy_buffering off;
  proxy_redirect off;
  proxy_http_version 1.1;
  tcp_nodelay on;

  location / {
    proxy_pass_header Server;
    proxy_pass http://127.0.0.1:3000;
  }

  location ~ ^/api/v[0-9]+/(statuses|media)$ {
    proxy_pass_header Server;
    if ($http_x_mulukhiya != '') {
      proxy_pass http://127.0.0.1:3000;
    }
    if ($http_x_mulukhiya = '') {
      proxy_pass http://127.0.0.1:3008;
    }
  }
  location ~ ^/api/v1/statuses/[0-9]+/(favourite|reblog|bookmark)$ {
    proxy_pass_header Server;
    if ($http_x_mulukhiya != '') {
      proxy_pass http://127.0.0.1:3000;
    }
    if ($http_x_mulukhiya = '') {
      proxy_pass http://127.0.0.1:3008;
    }
  }
  location ~ ^/api/v[0-9]+/media/[0-9]+$ {
    proxy_pass_header Server;
    set $test "${request_method}${http_x_mulukhiya}";
    if ($test ~* '^PUT.+') {
      proxy_pass http://127.0.0.1:3000;
    }
    if ($test = 'PUT') {
      proxy_pass http://127.0.0.1:3008;
    }
    if ($test ~* '^(GET|POST)') {
      proxy_pass http://127.0.0.1:3000;
    }
  }
  location ~ ^/api/v[0-9]+/statuses/[0-9]+$ {
    if ($http_x_mulukhiya_purpose != '') {
      proxy_pass http://127.0.0.1:3008;
    }
    set $test "${request_method}${http_x_mulukhiya}";
    if ($test ~* '^PUT.+') {
      proxy_pass http://127.0.0.1:3000;
    }
    if ($test = 'PUT') {
      return 405;
    }
    if ($test ~* '^(GET|POST|DELETE)') {
      proxy_pass http://127.0.0.1:3000;
    }
  }

  location ^~ /api/v1/streaming {
    proxy_pass http://127.0.0.1:4000;
  }
  location ^~ /feed {
    proxy_pass http://127.0.0.1:3001;
  }
  location ^~ /mulukhiya {
    proxy_pass http://127.0.0.1:3008;
  }
  location ^~ /mulukhiya/sidekiq {
    allow 127.0.0.1;
    allow 218.45.184.243; #seas
    deny all;
    proxy_pass http://127.0.0.1:3008;
  }
  location ^~ /makoto {
    proxy_pass http://127.0.0.1:3011;
  }
  location ^~ /makoto/sidekiq {
    allow 127.0.0.1;
    allow 218.45.184.243; #seas
    deny all;
    proxy_pass http://127.0.0.1:3011;
<<<<<<<< HEAD:dist/servers/precure.ml.conf
========
  }
  location ^~ /sidekiq {
    proxy_pass_header Server;
    proxy_pass http://127.0.0.1:3000;
>>>>>>>> work/4.3/delmulin:dist/servers/mstdn.delmulin.com.conf
  }
  location ^~ /nodeinfo {
    proxy_pass_header Server;
    if ($http_x_mulukhiya != '') {
      proxy_pass http://127.0.0.1:3000;
    }
    if ($http_x_mulukhiya = '') {
      proxy_pass http://127.0.0.1:3008;
    }
  }
  location ^~ /sidekiq {
    proxy_pass_header Server;
    proxy_pass http://127.0.0.1:3000;
  }
  location ~ ^/(packs|system|assets|emoji)/ {
    root /usr/local/www/mastodon/public;
  }
  location = /custom.css {
    proxy_pass_header Server;
    proxy_pass http://127.0.0.1:3000;
  }
  location = /manifest.json {
    proxy_pass_header Server;
    proxy_pass http://127.0.0.1:3000;
  }
  location ~ \.(js|json|css|map)$ {
    add_header Cache-Control "public, max-age=0";
    root /usr/local/www/mastodon/public;
  }
  location ~ \.(html|jpg|png|gif|mp4|xml|ico|svg|txt|ogg|mp3)$ {
    root /usr/local/www/mastodon/public;
  }

  location ^~ /media {
<<<<<<<< HEAD:dist/servers/precure.ml.conf
    rewrite ^/media/(.*) https://curesta.ap-south-1.linodeobjects.com/$1 redirect;
  }
  location ^~ /accounts {
    proxy_set_header Host curesta.ap-south-1.linodeobjects.com;
    proxy_pass https://curesta.ap-south-1.linodeobjects.com;
  }
  location ^~ /media_attachments {
    proxy_set_header Host curesta.ap-south-1.linodeobjects.com;
    proxy_pass https://curesta.ap-south-1.linodeobjects.com;
  }
  location ^~ /preview_cards {
    proxy_set_header Host curesta.ap-south-1.linodeobjects.com;
    proxy_pass https://curesta.ap-south-1.linodeobjects.com;
  }
  location ^~ /site_uploads {
    proxy_set_header Host curesta.ap-south-1.linodeobjects.com;
    proxy_pass https://curesta.ap-south-1.linodeobjects.com;
  }
  location ^~ /custom_emojis {
    proxy_set_header Host curesta.ap-south-1.linodeobjects.com;
    proxy_pass https://curesta.ap-south-1.linodeobjects.com;
  }
  location ^~ /cache {
    proxy_set_header Host curesta.ap-south-1.linodeobjects.com;
    proxy_pass https://curesta.ap-south-1.linodeobjects.com;
  }

  location = /api/v1/timelines/public {
    if ($arg_local !~* ^(true|t|1|on)$) {
      proxy_pass http://127.0.0.1:3000;
    }
    if ($arg_local ~* ^(true|t|1|on)$) {
      return 302 /api/v1/timelines/tag/precure_fun?max_id=$arg_max_id;
    }
  }

  location =/api/dic/v1/precure.json {
    return 302 https://script.google.com/macros/s/AKfycbwn4nqKhBwH3aDYd7bJ698-GWRJqpktpAdH11ramlBK87ym3ME/exec;
  }
  location =/api/dic/v1/dic.json {
    return 302 https://script.google.com/macros/s/AKfycbws9aCXxNQt3khdJ9bEt1ADeV7HzZV_Idg-DvN5t_X3nnca0nc/exec;
  }
  location =/api/dic/v1/fairy.json {
    return 302 https://script.google.com/macros/s/AKfycbyD1ew_D_9HCxXiHsEjLc23g_aJ51AbzoeNK60E6GQzJYG6hiE/exec;
  }
  location =/api/dic/v2/fairy.json {
    return 302 https://script.google.com/macros/s/AKfycbzfal5ejlywb-AbizAX4zq-90LNhKOR217QcxObjFZI5ZQeeFVY/exec;
  }
  location =/api/dic/v1/series.json {
    return 302 https://script.google.com/macros/s/AKfycbyy5EQHvhKfm1Lg6Ae4W7knG4BCSkvepJyB6MrzQ8UIxmFfZMJj/exec;
  }
  location =/api/dic/v1/singer.json {
    return 302 https://script.google.com/macros/s/AKfycbzAUsRUuFLO72EgKta020v9OMtxvUtqUcPZNJ3_IMlOo8dRO7tW/exec;
  }
  location =/api/program/v1/common.json {
    return 302 https://script.google.com/macros/s/AKfycbxlqRJxUq1dIsshRF6luZvL-_T08OTZD7YKOmAhLHfZeoZy3Ox-/exec;
  }
  location =/feed/v1.0/tag/precure_fun {
    return 301 https://precure.ml/mulukhiya/feed/tag/precure_fun;
========
    rewrite ^/media/(.*) https://delmulin.ap-south-1.linodeobjects.com/$1 redirect;
  }
  location ^~ /accounts {
    proxy_set_header Host delmulin.ap-south-1.linodeobjects.com;
    proxy_pass https://demulin.ap-south-1.linodeobjects.com;
  }
  location ^~ /media_attachments {
    proxy_set_header Host delmulin.ap-south-1.linodeobjects.com;
    proxy_pass https://demulin.ap-south-1.linodeobjects.com;
  }
  location ^~ /preview_cards {
    proxy_set_header Host delmulin.ap-south-1.linodeobjects.com;
    proxy_pass https://demulin.ap-south-1.linodeobjects.com;
  }
  location ^~ /site_uploads {
    proxy_set_header Host delmulin.ap-south-1.linodeobjects.com;
    proxy_pass https://demulin.ap-south-1.linodeobjects.com;
  }
  location ^~ /custom_emojis {
    proxy_set_header Host delmulin.ap-south-1.linodeobjects.com;
    proxy_pass https://demulin.ap-south-1.linodeobjects.com;
  }
  location ^~ /cache {
    proxy_set_header Host delmulin.ap-south-1.linodeobjects.com;
    proxy_pass https://demulin.ap-south-1.linodeobjects.com;
  }

  location = /api/v1/timelines/public {
    if ($arg_local !~* ^(true|t|on|1)$) {
      proxy_pass http://127.0.0.1:3000;
    }
    if ($arg_local ~* ^(true|t|on|1)$) {
      return 302 /api/v1/timelines/tag/delmulin?max_id=$arg_max_id;
    }
  }

  location =/api/character/v1/common.json {
    return 302 https://script.google.com/macros/s/AKfycbwJftzvIsTVJbZbXE3Qf7g1eSrYNwkoKzZRDX0OfIM-4HHbLffrJbcJ7A8P-CI_yigC_Q/exec;
  }
  location =/api/character/v1/detail.json {
    return 302 https://script.google.com/macros/s/AKfycbwJftzvIsTVJbZbXE3Qf7g1eSrYNwkoKzZRDX0OfIM-4HHbLffrJbcJ7A8P-CI_yigC_Q/exec?m=multi_field;
  }
  location =/api/anniversary/v1/common.json {
    return 302 https://script.google.com/macros/s/AKfycbzV_O0CIyRGTFjdgG9WzkR4ZJ2mYOTsCEeCw4o482Ziv3D3xbLp7ci8Gd9pdUMk6xO5jw/exec;
  }
  location =/api/dic/v1/common.json {
    return 302 https://script.google.com/macros/s/AKfycbx0epxeMejJ61iA5t-4kpZ9d9wUTHuHJLJkMQW0IRwyxZSB-2l7C2JP36PvhEtzsPzV/exec;
  }
  location =/api/dic/v1/service.json {
    return 302 https://script.google.com/macros/s/AKfycbxkcvrTTieJCeGotxlyENQ5vpS1RQnoLFzH3ti5UOHsuTFOfpE/exec;
>>>>>>>> work/4.3/delmulin:dist/servers/mstdn.delmulin.com.conf
  }
  location =/api/program/v1/common.json {
    return 302 https://script.google.com/macros/s/AKfycbzmh-GC9c6p3-8IQhawJhszGQ-BPydAbPsSbfHdYfut7S6QQjdhRxe2VnbjMjiU0Hw0/exec;
  }

  error_page 500 501 502 503 504 /500.html;

  if (-e /tmp/maintenance) {
    return 503;
  }
<<<<<<<< HEAD:dist/servers/precure.ml.conf
  if (-e /tmp/precure.ml) {
========
  if (-e /tmp/mstdn.delmulin.com) {
>>>>>>>> work/4.3/delmulin:dist/servers/mstdn.delmulin.com.conf
    return 503;
  }
}
